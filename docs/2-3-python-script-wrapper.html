<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="2.3 Python Script Wrapper | Getting Started with BisQue" />
<meta property="og:type" content="book" />

<meta property="og:image" content="images/cover.png" />
<meta property="og:description" content="BisQue (Bio-Image Semantic Query User Environment) : Store, visualize,organize and analyze images in the cloud." />




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>

<meta name="description" content="BisQue (Bio-Image Semantic Query User Environment) : Store, visualize,organize and analyze images in the cloud.">

<title>2.3 Python Script Wrapper | Getting Started with BisQue</title>

<script src="libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="libs/navigation-1.1/tabsets.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<link rel="stylesheet" href="style.css" type="text/css" />

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
</style>
</head>

<body>

<div class="container-fluid main-container">


<div class="row">
<div class="col-sm-12">
<div id="TOC">
<ul>
<li class="has-sub"><a href="index.html#cloud-service-module-development-python-api">Cloud Service | Module Development | Python API</a><ul>
<li class="has-sub"><a href="docker-installation.html#docker-installation">Docker Installation</a><ul>
<li><a href="docker-installation.html#intro-bisque-docker-container"><strong>Intro: BisQue Docker Container</strong></a></li>
</ul></li>
</ul></li>
<li class="has-sub"><a href="1-intro.html#intro"><span class="toc-section-number">1</span> BisQue Cloud Service</a><ul>
<li><a href="1-1-how-to-login-or-create-a-new-user.html#how-to-login-or-create-a-new-user"><span class="toc-section-number">1.1</span> How to Login or Create a New User</a></li>
<li class="has-sub"><a href="1-2-how-to-upload-data.html#how-to-upload-data"><span class="toc-section-number">1.2</span> How to Upload Data</a><ul>
<li><a href="1-2-how-to-upload-data.html#step-1.-login">Step 1. Login</a></li>
<li><a href="1-2-how-to-upload-data.html#step-2.-upload-file-or-folder">Step 2. Upload File or Folder</a></li>
<li><a href="1-2-how-to-upload-data.html#step-3.-build-a-dataset">Step 3. Build a Dataset</a></li>
<li><a href="1-2-how-to-upload-data.html#step-4.-setting-permissions">Step 4. Setting Permissions</a></li>
</ul></li>
<li class="has-sub"><a href="1-3-how-to-add-annotations.html#how-to-add-annotations"><span class="toc-section-number">1.3</span> How to Add Annotations</a><ul>
<li><a href="1-3-how-to-add-annotations.html#overview">Overview</a></li>
</ul></li>
<li><a href="1-4-how-to-run-a-module.html#how-to-run-a-module"><span class="toc-section-number">1.4</span> How to Run a Module</a></li>
<li class="has-sub"><a href="1-5-imagej-module.html#imagej-module"><span class="toc-section-number">1.5</span> ImageJ Module</a><ul>
<li><a href="1-5-imagej-module.html#overview-1">Overview</a></li>
<li><a href="1-5-imagej-module.html#uploading-of-imagej-pipelines">Uploading of ImageJ Pipelines</a></li>
<li><a href="1-5-imagej-module.html#running-an-imagej-macro">Running an ImageJ Macro</a></li>
<li><a href="1-5-imagej-module.html#special-bisque-extensions-for-imagej">Special BisQue extensions for ImageJ</a></li>
</ul></li>
<li class="has-sub"><a href="1-6-cellprofiler-module.html#cellprofiler-module"><span class="toc-section-number">1.6</span> CellProfiler Module</a><ul>
<li><a href="1-6-cellprofiler-module.html#overview-2">Overview</a></li>
<li><a href="1-6-cellprofiler-module.html#uploading-of-cellprofiler-pipelines">Uploading of CellProfiler Pipelines</a></li>
<li><a href="1-6-cellprofiler-module.html#running-a-cellprofiler-pipeline">Running a CellProfiler Pipeline</a></li>
<li><a href="1-6-cellprofiler-module.html#results">Results</a></li>
</ul></li>
<li class="has-sub"><a href="1-7-plant-cell-segmentation.html#plant-cell-segmentation"><span class="toc-section-number">1.7</span> Plant Cell Segmentation</a><ul>
<li><a href="1-7-plant-cell-segmentation.html#overview-3">Overview</a></li>
<li><a href="1-7-plant-cell-segmentation.html#input"><strong><code>Input</code></strong></a></li>
<li><a href="1-7-plant-cell-segmentation.html#hyperparameters">Hyperparameters</a></li>
<li><a href="1-7-plant-cell-segmentation.html#cell-features">Cell Features</a></li>
<li><a href="1-7-plant-cell-segmentation.html#output"><strong><code>Output</code></strong></a></li>
</ul></li>
</ul></li>
<li class="has-sub"><a href="2-module-development.html#module-development"><span class="toc-section-number">2</span> Module Development</a><ul>
<li><a href="2-module-development.html#how-to-begin-building-modules"><strong>How to Begin Building Modules</strong></a></li>
<li class="has-sub"><a href="2-1-dockerfile.html#dockerfile"><span class="toc-section-number">2.1</span> Dockerfile</a><ul>
<li><a href="2-1-dockerfile.html#example-composite-strength"><strong>Example: Composite Strength</strong></a></li>
</ul></li>
<li class="has-sub"><a href="2-2-module-xml.html#module-xml"><span class="toc-section-number">2.2</span> Module XML</a><ul>
<li><a href="2-2-module-xml.html#example"><strong>Example</strong></a></li>
<li><a href="2-2-module-xml.html#module-description">Module Description</a></li>
<li><a href="2-2-module-xml.html#configurations-for-images-datasets-and-resources">Configurations for Images, Datasets, and Resources</a></li>
<li><a href="2-2-module-xml.html#data-parallel-execution">Data-Parallel Execution</a></li>
</ul></li>
<li class="has-sub"><a href="2-3-python-script-wrapper.html#python-script-wrapper"><span class="toc-section-number">2.3</span> Python Script Wrapper</a><ul>
<li><a href="2-3-python-script-wrapper.html#example.-python-script-wrapper"><em>Example.</em> Python Script Wrapper</a></li>
</ul></li>
<li class="has-sub"><a href="2-4-source-code.html#source-code"><span class="toc-section-number">2.4</span> Source Code</a><ul>
<li><a href="2-4-source-code.html#example.-composite-strength-module"><em>Example.</em> Composite Strength Module</a></li>
</ul></li>
<li class="has-sub"><a href="2-5-runtime-module-configuration.html#runtime-module-configuration"><span class="toc-section-number">2.5</span> Runtime Module Configuration</a><ul>
<li><a href="2-5-runtime-module-configuration.html#example.-composite-strength-module-1"><em>Example.</em> Composite Strength Module</a></li>
</ul></li>
<li><a href="2-6-python-setup.html#python-setup"><span class="toc-section-number">2.6</span> Python Setup</a></li>
</ul></li>
<li class="has-sub"><a href="3-bqapi.html#bqapi"><span class="toc-section-number">3</span> BQAPI</a><ul>
<li class="has-sub"><a href="download-an-array.html#download-an-array"><strong>Download an Array</strong></a><ul>
<li><a href="download-an-array.html#access-an-hdf5-table-from-bisque">Access an HDF5 Table from BisQue</a></li>
</ul></li>
<li><a href="upload-an-image.html#upload-an-image"><strong>Upload an Image</strong></a></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div class="row">
<div class="col-sm-12">
<div id="python-script-wrapper" class="section level2">
<h2><span class="header-section-number">2.3</span> Python Script Wrapper</h2>
<blockquote>
<p><strong>FILENAME: </strong> <code>PythonScriptWrapper.py</code></p>
</blockquote>
<div id="example.-python-script-wrapper" class="section level3 unnumbered">
<h3><em>Example.</em> Python Script Wrapper</h3>
<div id="imports" class="section level4 unnumbered">
<h4>Imports</h4>
<p>The main imports for the <code>PythonScriptWrapper</code> are mostly for logging and communicating with BisQue. In this code snippet, the line <code>from NAME_OF_MODULE import predict_function</code> is importing a prediction function from a single <code>Python</code> file. If multiple functions need to be imported from a source folder, make sure there is an <code>__init__.py</code> or there will be import errors.</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb145-1" title="1"><span class="im">import</span> sys</a>
<a class="sourceLine" id="cb145-2" title="2"><span class="im">import</span> io</a>
<a class="sourceLine" id="cb145-3" title="3"><span class="im">from</span> lxml <span class="im">import</span> etree</a>
<a class="sourceLine" id="cb145-4" title="4"><span class="im">import</span> optparse</a>
<a class="sourceLine" id="cb145-5" title="5"><span class="im">import</span> logging</a>
<a class="sourceLine" id="cb145-6" title="6"></a>
<a class="sourceLine" id="cb145-7" title="7"></a>
<a class="sourceLine" id="cb145-8" title="8"><span class="im">from</span> NAME_OF_MODULE <span class="im">import</span> predict_function</a>
<a class="sourceLine" id="cb145-9" title="9"></a>
<a class="sourceLine" id="cb145-10" title="10"></a>
<a class="sourceLine" id="cb145-11" title="11">logging.basicConfig(filename<span class="op">=</span><span class="st">&#39;PythonScript.log&#39;</span>,filemode<span class="op">=</span><span class="st">&#39;a&#39;</span>,level<span class="op">=</span>logging.DEBUG)</a>
<a class="sourceLine" id="cb145-12" title="12">log <span class="op">=</span> logging.getLogger(<span class="st">&#39;bq.modules&#39;</span>)</a>
<a class="sourceLine" id="cb145-13" title="13"></a>
<a class="sourceLine" id="cb145-14" title="14"></a>
<a class="sourceLine" id="cb145-15" title="15"><span class="im">from</span> bqapi.comm <span class="im">import</span> BQCommError</a>
<a class="sourceLine" id="cb145-16" title="16"><span class="im">from</span> bqapi.comm <span class="im">import</span> BQSession</a></code></pre></div>
</div>
<div id="python-script-wrapper-class" class="section level4 unnumbered">
<h4>Python Script Wrapper Class</h4>
<p>The class contains all of the functions needed to initialize, run, and save the module results back to BisQue as a resource. For instance, if the output is an image, the resource would be of type image and uploaded to BisQue as an image.</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb146-1" title="1"><span class="kw">class</span> PythonScriptWrapper(<span class="bu">object</span>):</a>
<a class="sourceLine" id="cb146-2" title="2">    <span class="kw">def</span> run(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb146-3" title="3">        <span class="co">&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb146-4" title="4"><span class="co">        Run Python script</span></a>
<a class="sourceLine" id="cb146-5" title="5"><span class="co">        &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb146-6" title="6">        bq <span class="op">=</span> <span class="va">self</span>.bqSession</a>
<a class="sourceLine" id="cb146-7" title="7">        </a>
<a class="sourceLine" id="cb146-8" title="8">        <span class="co"># call script</span></a>
<a class="sourceLine" id="cb146-9" title="9">        outputs <span class="op">=</span> predict_function( bq, log, <span class="op">**</span><span class="va">self</span>.options.__dict__ )</a>
<a class="sourceLine" id="cb146-10" title="10">        </a>
<a class="sourceLine" id="cb146-11" title="11">        <span class="co"># save output back to BisQue</span></a>
<a class="sourceLine" id="cb146-12" title="12">        <span class="cf">for</span> output <span class="kw">in</span> outputs:</a>
<a class="sourceLine" id="cb146-13" title="13">            <span class="va">self</span>.output_resources.append(output)</a>
<a class="sourceLine" id="cb146-14" title="14">    </a>
<a class="sourceLine" id="cb146-15" title="15">    <span class="kw">def</span> setup(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb146-16" title="16">        <span class="co">&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb146-17" title="17"><span class="co">        Pre-run initialization</span></a>
<a class="sourceLine" id="cb146-18" title="18"><span class="co">        &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb146-19" title="19">        <span class="va">self</span>.bqSession.update_mex(<span class="st">&#39;Initializing...&#39;</span>)</a>
<a class="sourceLine" id="cb146-20" title="20">        <span class="va">self</span>.mex_parameter_parser(<span class="va">self</span>.bqSession.mex.xmltree)</a>
<a class="sourceLine" id="cb146-21" title="21">        <span class="va">self</span>.output_resources <span class="op">=</span> []</a>
<a class="sourceLine" id="cb146-22" title="22"></a>
<a class="sourceLine" id="cb146-23" title="23">    <span class="kw">def</span> teardown(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb146-24" title="24">        <span class="co">&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb146-25" title="25"><span class="co">        Post the results to the mex xml</span></a>
<a class="sourceLine" id="cb146-26" title="26"><span class="co">        &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb146-27" title="27">        <span class="va">self</span>.bqSession.update_mex( <span class="st">&#39;Returning results&#39;</span>)</a>
<a class="sourceLine" id="cb146-28" title="28"></a>
<a class="sourceLine" id="cb146-29" title="29">        outputTag <span class="op">=</span> etree.Element(<span class="st">&#39;tag&#39;</span>, name <span class="op">=</span><span class="st">&#39;outputs&#39;</span>)</a>
<a class="sourceLine" id="cb146-30" title="30">        <span class="cf">for</span> r_xml <span class="kw">in</span> <span class="va">self</span>.output_resources:</a>
<a class="sourceLine" id="cb146-31" title="31">            <span class="cf">if</span> <span class="bu">isinstance</span>(r_xml, <span class="bu">basestring</span>):</a>
<a class="sourceLine" id="cb146-32" title="32">                r_xml <span class="op">=</span> etree.fromstring(r_xml) </a>
<a class="sourceLine" id="cb146-33" title="33">            res_type <span class="op">=</span> r_xml.get(<span class="st">&#39;type&#39;</span>, <span class="va">None</span>) <span class="kw">or</span> r_xml.get(<span class="st">&#39;resource_type&#39;</span>, <span class="va">None</span>) <span class="kw">or</span> r_xml.tag</a>
<a class="sourceLine" id="cb146-34" title="34">            <span class="co"># append reference to output</span></a>
<a class="sourceLine" id="cb146-35" title="35">            <span class="cf">if</span> res_type <span class="kw">in</span> [<span class="st">&#39;table&#39;</span>, <span class="st">&#39;image&#39;</span>]:</a>
<a class="sourceLine" id="cb146-36" title="36">                outputTag.append(r_xml)</a>
<a class="sourceLine" id="cb146-37" title="37">                <span class="co">#etree.SubElement(outputTag, &#39;tag&#39;, name=&#39;output_table&#39; if res_type==&#39;table&#39; else &#39;output_image&#39;, type=res_type, value=r_xml.get(&#39;uri&#39;,&#39;&#39;))</span></a>
<a class="sourceLine" id="cb146-38" title="38">            <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb146-39" title="39">                outputTag.append(r_xml)</a>
<a class="sourceLine" id="cb146-40" title="40">                <span class="co">#etree.SubElement(outputTag, r_xml.tag, name=r_xml.get(&#39;name&#39;, &#39;_&#39;), type=r_xml.get(&#39;type&#39;, &#39;string&#39;), value=r_xml.get(&#39;value&#39;, &#39;&#39;))</span></a>
<a class="sourceLine" id="cb146-41" title="41">        <span class="va">self</span>.bqSession.finish_mex(tags<span class="op">=</span>[outputTag])</a>
<a class="sourceLine" id="cb146-42" title="42"></a>
<a class="sourceLine" id="cb146-43" title="43">    <span class="kw">def</span> mex_parameter_parser(<span class="va">self</span>, mex_xml):</a>
<a class="sourceLine" id="cb146-44" title="44">        <span class="co">&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb146-45" title="45"><span class="co">            Parses input of the xml and add it to options attribute (unless already set)</span></a>
<a class="sourceLine" id="cb146-46" title="46"></a>
<a class="sourceLine" id="cb146-47" title="47"><span class="co">            @param: mex_xml</span></a>
<a class="sourceLine" id="cb146-48" title="48"><span class="co">        &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb146-49" title="49">        <span class="co"># inputs are all non-&quot;script_params&quot; under &quot;inputs&quot; and all params under &quot;script_params&quot;</span></a>
<a class="sourceLine" id="cb146-50" title="50">        mex_inputs <span class="op">=</span> mex_xml.xpath(<span class="st">&#39;tag[@name=&quot;inputs&quot;]/tag[@name!=&quot;script_params&quot;] | tag[@name=&quot;inputs&quot;]/tag[@name=&quot;script_params&quot;]/tag&#39;</span>)</a>
<a class="sourceLine" id="cb146-51" title="51">        <span class="cf">if</span> mex_inputs:</a>
<a class="sourceLine" id="cb146-52" title="52">            <span class="cf">for</span> tag <span class="kw">in</span> mex_inputs:</a>
<a class="sourceLine" id="cb146-53" title="53">                <span class="cf">if</span> tag.tag <span class="op">==</span> <span class="st">&#39;tag&#39;</span> <span class="kw">and</span> tag.get(<span class="st">&#39;type&#39;</span>, <span class="st">&#39;&#39;</span>) <span class="op">!=</span> <span class="st">&#39;system-input&#39;</span>: <span class="co">#skip system input values</span></a>
<a class="sourceLine" id="cb146-54" title="54">                    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">getattr</span>(<span class="va">self</span>.options,tag.get(<span class="st">&#39;name&#39;</span>, <span class="st">&#39;&#39;</span>), <span class="va">None</span>):</a>
<a class="sourceLine" id="cb146-55" title="55">                        log.debug(<span class="st">&#39;Set options with </span><span class="sc">%s</span><span class="st"> as </span><span class="sc">%s</span><span class="st">&#39;</span><span class="op">%</span>(tag.get(<span class="st">&#39;name&#39;</span>,<span class="st">&#39;&#39;</span>),tag.get(<span class="st">&#39;value&#39;</span>,<span class="st">&#39;&#39;</span>)))</a>
<a class="sourceLine" id="cb146-56" title="56">                        <span class="bu">setattr</span>(<span class="va">self</span>.options,tag.get(<span class="st">&#39;name&#39;</span>,<span class="st">&#39;&#39;</span>),tag.get(<span class="st">&#39;value&#39;</span>,<span class="st">&#39;&#39;</span>))</a>
<a class="sourceLine" id="cb146-57" title="57">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb146-58" title="58">            log.debug(<span class="st">&#39;No Inputs Found on MEX!&#39;</span>)</a>
<a class="sourceLine" id="cb146-59" title="59"></a>
<a class="sourceLine" id="cb146-60" title="60">    <span class="kw">def</span> validate_input(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb146-61" title="61">        <span class="co">&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb146-62" title="62"><span class="co">            Check to see if a mex with token or user with password was provided.</span></a>
<a class="sourceLine" id="cb146-63" title="63"></a>
<a class="sourceLine" id="cb146-64" title="64"><span class="co">            @return True is returned if validation credention was provided else</span></a>
<a class="sourceLine" id="cb146-65" title="65"><span class="co">            False is returned</span></a>
<a class="sourceLine" id="cb146-66" title="66"><span class="co">        &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb146-67" title="67">        <span class="cf">if</span> (<span class="va">self</span>.options.mexURL <span class="kw">and</span> <span class="va">self</span>.options.token): <span class="co">#run module through engine service</span></a>
<a class="sourceLine" id="cb146-68" title="68">            <span class="cf">return</span> <span class="va">True</span></a>
<a class="sourceLine" id="cb146-69" title="69"></a>
<a class="sourceLine" id="cb146-70" title="70">        <span class="cf">if</span> (<span class="va">self</span>.options.user <span class="kw">and</span> <span class="va">self</span>.options.pwd <span class="kw">and</span> <span class="va">self</span>.options.root): <span class="co">#run module locally (note: to test module)</span></a>
<a class="sourceLine" id="cb146-71" title="71">            <span class="cf">return</span> <span class="va">True</span></a>
<a class="sourceLine" id="cb146-72" title="72"></a>
<a class="sourceLine" id="cb146-73" title="73">        log.debug(<span class="st">&#39;Insufficient options or arguments to start this module&#39;</span>)</a>
<a class="sourceLine" id="cb146-74" title="74">        <span class="cf">return</span> <span class="va">False</span></a></code></pre></div>
</div>
<div id="main-function" class="section level4 unnumbered">
<h4>Main Function</h4>
<p>The main function enables the communication between BisQue and the module. For example, when a module is run under a user, we need to make sure that the unique ID is registered with the user.</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb147-1" title="1"><span class="kw">def</span> main(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb147-2" title="2">    parser <span class="op">=</span> optparse.OptionParser()</a>
<a class="sourceLine" id="cb147-3" title="3">    parser.add_option(<span class="st">&#39;--mex_url&#39;</span>         , dest<span class="op">=</span><span class="st">&quot;mexURL&quot;</span>)</a>
<a class="sourceLine" id="cb147-4" title="4">    parser.add_option(<span class="st">&#39;--module_dir&#39;</span>      , dest<span class="op">=</span><span class="st">&quot;modulePath&quot;</span>)</a>
<a class="sourceLine" id="cb147-5" title="5">    parser.add_option(<span class="st">&#39;--staging_path&#39;</span>    , dest<span class="op">=</span><span class="st">&quot;stagingPath&quot;</span>)</a>
<a class="sourceLine" id="cb147-6" title="6">    parser.add_option(<span class="st">&#39;--bisque_token&#39;</span>    , dest<span class="op">=</span><span class="st">&quot;token&quot;</span>)</a>
<a class="sourceLine" id="cb147-7" title="7">    parser.add_option(<span class="st">&#39;--user&#39;</span>            , dest<span class="op">=</span><span class="st">&quot;user&quot;</span>)</a>
<a class="sourceLine" id="cb147-8" title="8">    parser.add_option(<span class="st">&#39;--pwd&#39;</span>             , dest<span class="op">=</span><span class="st">&quot;pwd&quot;</span>)</a>
<a class="sourceLine" id="cb147-9" title="9">    parser.add_option(<span class="st">&#39;--root&#39;</span>            , dest<span class="op">=</span><span class="st">&quot;root&quot;</span>)</a>
<a class="sourceLine" id="cb147-10" title="10">        </a>
<a class="sourceLine" id="cb147-11" title="11">    (options, args) <span class="op">=</span> parser.parse_args()</a>
<a class="sourceLine" id="cb147-12" title="12"></a>
<a class="sourceLine" id="cb147-13" title="13">    fh <span class="op">=</span> logging.FileHandler(<span class="st">&#39;scriptrun.log&#39;</span>, mode<span class="op">=</span><span class="st">&#39;a&#39;</span>)</a>
<a class="sourceLine" id="cb147-14" title="14">    fh.setLevel(logging.DEBUG)</a>
<a class="sourceLine" id="cb147-15" title="15">    formatter <span class="op">=</span> logging.Formatter(<span class="st">&#39;[</span><span class="sc">%(asctime)s</span><span class="st">] </span><span class="sc">%(levelname)8s</span><span class="st"> --- </span><span class="sc">%(message)s</span><span class="st"> &#39;</span> <span class="op">+</span></a>
<a class="sourceLine" id="cb147-16" title="16">                              <span class="st">&#39;(</span><span class="sc">%(filename)s</span><span class="st">:</span><span class="sc">%(lineno)s</span><span class="st">)&#39;</span>,datefmt<span class="op">=</span><span class="st">&#39;%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S&#39;</span>)</a>
<a class="sourceLine" id="cb147-17" title="17">    fh.setFormatter(formatter)</a>
<a class="sourceLine" id="cb147-18" title="18">    log.addHandler(fh)</a>
<a class="sourceLine" id="cb147-19" title="19"></a>
<a class="sourceLine" id="cb147-20" title="20">    <span class="cf">try</span>: <span class="co">#pull out the mex</span></a>
<a class="sourceLine" id="cb147-21" title="21"></a>
<a class="sourceLine" id="cb147-22" title="22">        <span class="cf">if</span> <span class="kw">not</span> options.mexURL:</a>
<a class="sourceLine" id="cb147-23" title="23">            options.mexURL <span class="op">=</span> sys.argv[<span class="op">-</span><span class="dv">2</span>]</a>
<a class="sourceLine" id="cb147-24" title="24">        <span class="cf">if</span> <span class="kw">not</span> options.token:</a>
<a class="sourceLine" id="cb147-25" title="25">            options.token <span class="op">=</span> sys.argv[<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb147-26" title="26"></a>
<a class="sourceLine" id="cb147-27" title="27">    <span class="cf">except</span> <span class="pp">IndexError</span>: <span class="co">#no argv were set</span></a>
<a class="sourceLine" id="cb147-28" title="28">        <span class="cf">pass</span></a>
<a class="sourceLine" id="cb147-29" title="29"></a>
<a class="sourceLine" id="cb147-30" title="30">    <span class="cf">if</span> <span class="kw">not</span> options.stagingPath:</a>
<a class="sourceLine" id="cb147-31" title="31">        options.stagingPath <span class="op">=</span> <span class="st">&#39;&#39;</span></a>
<a class="sourceLine" id="cb147-32" title="32"></a>
<a class="sourceLine" id="cb147-33" title="33">    log.info(<span class="st">&#39;</span><span class="ch">\n\n</span><span class="st">PARAMS : </span><span class="sc">%s</span><span class="st"> </span><span class="ch">\n\n</span><span class="st"> Options: </span><span class="sc">%s</span><span class="st">&#39;</span> <span class="op">%</span> (args, options))</a>
<a class="sourceLine" id="cb147-34" title="34">    <span class="va">self</span>.options <span class="op">=</span> options</a>
<a class="sourceLine" id="cb147-35" title="35"></a>
<a class="sourceLine" id="cb147-36" title="36">    <span class="cf">if</span> <span class="va">self</span>.validate_input():</a>
<a class="sourceLine" id="cb147-37" title="37"></a>
<a class="sourceLine" id="cb147-38" title="38">        <span class="co">#initalizes if user and password are provided</span></a>
<a class="sourceLine" id="cb147-39" title="39">        <span class="cf">if</span> (<span class="va">self</span>.options.user <span class="kw">and</span> <span class="va">self</span>.options.pwd <span class="kw">and</span> <span class="va">self</span>.options.root):</a>
<a class="sourceLine" id="cb147-40" title="40">            <span class="va">self</span>.bqSession <span class="op">=</span> BQSession().init_local( <span class="va">self</span>.options.user, <span class="va">self</span>.options.pwd, bisque_root<span class="op">=</span><span class="va">self</span>.options.root)</a>
<a class="sourceLine" id="cb147-41" title="41">            <span class="va">self</span>.options.mexURL <span class="op">=</span> <span class="va">self</span>.bqSession.mex.uri</a>
<a class="sourceLine" id="cb147-42" title="42"></a>
<a class="sourceLine" id="cb147-43" title="43">        <span class="co">#initalizes if mex and mex token is provided</span></a>
<a class="sourceLine" id="cb147-44" title="44">        <span class="cf">elif</span> (<span class="va">self</span>.options.mexURL <span class="kw">and</span> <span class="va">self</span>.options.token):</a>
<a class="sourceLine" id="cb147-45" title="45">            <span class="va">self</span>.bqSession <span class="op">=</span> BQSession().init_mex(<span class="va">self</span>.options.mexURL, <span class="va">self</span>.options.token)</a>
<a class="sourceLine" id="cb147-46" title="46"></a>
<a class="sourceLine" id="cb147-47" title="47">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb147-48" title="48">            <span class="cf">raise</span> ScriptError(<span class="st">&#39;Insufficient options or arguments to start this module&#39;</span>)</a>
<a class="sourceLine" id="cb147-49" title="49"></a>
<a class="sourceLine" id="cb147-50" title="50">        <span class="cf">try</span>:</a>
<a class="sourceLine" id="cb147-51" title="51">            <span class="va">self</span>.setup()</a>
<a class="sourceLine" id="cb147-52" title="52">        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</a>
<a class="sourceLine" id="cb147-53" title="53">            log.exception(<span class="st">&quot;Exception during setup&quot;</span>)</a>
<a class="sourceLine" id="cb147-54" title="54">            <span class="va">self</span>.bqSession.fail_mex(msg <span class="op">=</span> <span class="st">&quot;Exception during setup: </span><span class="sc">%s</span><span class="st">&quot;</span> <span class="op">%</span>  <span class="bu">str</span>(e))</a>
<a class="sourceLine" id="cb147-55" title="55">            <span class="cf">return</span></a>
<a class="sourceLine" id="cb147-56" title="56"></a>
<a class="sourceLine" id="cb147-57" title="57">        <span class="cf">try</span>:</a>
<a class="sourceLine" id="cb147-58" title="58">            <span class="va">self</span>.run()</a>
<a class="sourceLine" id="cb147-59" title="59">        <span class="cf">except</span> (<span class="pp">Exception</span>, ScriptError) <span class="im">as</span> e:</a>
<a class="sourceLine" id="cb147-60" title="60">            log.exception(<span class="st">&quot;Exception during run&quot;</span>)</a>
<a class="sourceLine" id="cb147-61" title="61">            <span class="va">self</span>.bqSession.fail_mex(msg <span class="op">=</span> <span class="st">&quot;Exception during run: </span><span class="sc">%s</span><span class="st">&quot;</span> <span class="op">%</span> <span class="bu">str</span>(e))</a>
<a class="sourceLine" id="cb147-62" title="62">            <span class="cf">return</span></a>
<a class="sourceLine" id="cb147-63" title="63"></a>
<a class="sourceLine" id="cb147-64" title="64">        <span class="cf">try</span>:</a>
<a class="sourceLine" id="cb147-65" title="65">            <span class="va">self</span>.teardown()</a>
<a class="sourceLine" id="cb147-66" title="66">        <span class="cf">except</span> (<span class="pp">Exception</span>, ScriptError) <span class="im">as</span> e:</a>
<a class="sourceLine" id="cb147-67" title="67">            log.exception(<span class="st">&quot;Exception during teardown&quot;</span>)</a>
<a class="sourceLine" id="cb147-68" title="68">            <span class="va">self</span>.bqSession.fail_mex(msg <span class="op">=</span> <span class="st">&quot;Exception during teardown: </span><span class="sc">%s</span><span class="st">&quot;</span> <span class="op">%</span>  <span class="bu">str</span>(e))</a>
<a class="sourceLine" id="cb147-69" title="69">            <span class="cf">return</span></a>
<a class="sourceLine" id="cb147-70" title="70">    </a>
<a class="sourceLine" id="cb147-71" title="71">        <span class="va">self</span>.bqSession.close()</a>
<a class="sourceLine" id="cb147-72" title="72"></a>
<a class="sourceLine" id="cb147-73" title="73"><span class="cf">if</span> <span class="va">__name__</span><span class="op">==</span><span class="st">&quot;__main__&quot;</span>:</a>
<a class="sourceLine" id="cb147-74" title="74">    PythonScriptWrapper().main()</a></code></pre></div>
</div>
</div>
</div>
<p style="text-align: center;">
<a href="2-2-module-xml.html"><button class="btn btn-default">Previous</button></a>
<a href="2-4-source-code.html"><button class="btn btn-default">Next</button></a>
</p>
</div>
</div>


</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

</body>
</html>
